<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Voting History - E-Voting System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #34495e;
        }

        .sidebar-header h2 {
            color: #ecf0f1;
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            color: #bdc3c7;
            font-size: 14px;
        }

        .sidebar-nav ul {
            list-style: none;
            padding: 20px 0;
        }

        .sidebar-nav li {
            margin-bottom: 5px;
        }

        .sidebar-nav a {
            display: block;
            padding: 12px 25px;
            color: #ecf0f1;
            text-decoration: none;
            transition: all 0.3s;
        }

        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            background: #34495e;
            border-left: 3px solid #3498db;
        }

        .sidebar-nav i {
            margin-right: 10px;
            width: 20px;
            display: inline-block;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 30px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .back-link {
            color: #3498db;
            text-decoration: none;
            font-size: 14px;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .page-title {
            margin-bottom: 30px;
        }

        .page-title h1 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .page-title p {
            color: #7f8c8d;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-number {
            font-size: 48px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #95a5a6;
            font-size: 14px;
        }

        /* History List */
        .history-container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h2 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #95a5a6;
            margin-bottom: 30px;
        }

        .btn-browse {
            padding: 12px 30px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
        }

        .btn-browse:hover {
            background: #2980b9;
        }

        .history-item {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .election-info h3 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .election-info p {
            color: #7f8c8d;
            font-size: 14px;
        }

        .vote-date {
            color: #95a5a6;
            font-size: 13px;
            margin-top: 5px;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-completed {
            background: #d4edda;
            color: #155724;
        }

        .btn-view {
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-view:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>E-VOTING</h2>
                <p>Voter Panel</p>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="voter-dashboard.html"><i>üìä</i> Dashboard</a></li>
                    <li><a href="voter-profile.html"><i>üë§</i> My Profile</a></li>
                    <li><a href="voter-history.html" class="active"><i>üìã</i> Voting History</a></li>
                    <li><a href="#" id="logout"><i>üö™</i> Logout</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <a href="voter-dashboard.html" class="back-link">‚Üê Back to Dashboard</a>
            </div>

            <div class="page-title">
                <h1>My Voting History</h1>
                <p>Track all your past votes and election participation</p>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Votes Cast</h3>
                    <div class="stat-number" id="totalVotes">0</div>
                    <div class="stat-label">votes across all elections</div>
                </div>
                <div class="stat-card">
                    <h3>Elections Participated</h3>
                    <div class="stat-number" id="electionsParticipated">0</div>
                    <div class="stat-label">out of <span id="totalElections">2</span> total</div>
                </div>
            </div>

            <!-- History List -->
            <div class="history-container">
                <div id="historyList">
                    <!-- History items will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <script>
        // At the top of each HTML file's script section
const API_BASE_URL = (function() {
    // Check if we're running on localhost
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        return '/api';
    }
    // Production - use the Railway URL
    return 'https://e-voting-system.up.railway.app/api';
})();

        // Check authentication
        async function checkAuth() {
            const token = localStorage.getItem('token');
            const userStr = localStorage.getItem('user');
            
            if (!token || !userStr) {
                window.location.href = '/';
                return;
            }

            try {
                currentUser = JSON.parse(userStr);
                
                if (currentUser.role !== 'voter') {
                    window.location.href = currentUser.role === 'admin' ? '/admin-dashboard.html' : '/staff-dashboard.html';
                    return;
                }

                loadVotingHistory();
            } catch (error) {
                console.error('Auth error:', error);
                window.location.href = '/';
            }
        }

        // Load voting history
        async function loadVotingHistory() {
            try {
                const token = localStorage.getItem('token');
                
                // Try to fetch from backend
                const response = await fetch(`${API_BASE_URL}/votes/my-history`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayHistory(data);
                } else {
                    // Show empty state for demo
                    showEmptyHistory();
                }
            } catch (error) {
                console.error('Error loading history:', error);
                showEmptyHistory();
            }
        }

        function showEmptyHistory() {
            document.getElementById('totalVotes').textContent = '0';
            document.getElementById('electionsParticipated').textContent = '0';
            document.getElementById('totalElections').textContent = '2';

            document.getElementById('historyList').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üó≥Ô∏è</div>
                    <h2>No voting history yet</h2>
                    <p>You haven't participated in any elections yet.</p>
                    <a href="voter-dashboard.html" class="btn-browse">Browse Active Elections</a>
                </div>
            `;
        }

        function displayHistory(data) {
            const totalVotes = data.votes?.length || 0;
            const uniqueElections = new Set(data.votes?.map(v => v.election_id)).size || 0;
            
            document.getElementById('totalVotes').textContent = totalVotes;
            document.getElementById('electionsParticipated').textContent = uniqueElections;
            document.getElementById('totalElections').textContent = data.totalElections || 2;

            if (totalVotes === 0) {
                showEmptyHistory();
                return;
            }

            // Group votes by election
            const electionsMap = new Map();
            data.votes.forEach(vote => {
                if (!electionsMap.has(vote.election_id)) {
                    electionsMap.set(vote.election_id, {
                        id: vote.election_id,
                        title: vote.election_title,
                        date: vote.voted_at,
                        positions: []
                    });
                }
                electionsMap.get(vote.election_id).positions.push({
                    name: vote.position_name,
                    candidate: vote.candidate_name
                });
            });

            const historyHtml = Array.from(electionsMap.values()).map(election => `
                <div class="history-item">
                    <div class="election-info">
                        <h3>${election.title}</h3>
                        <p>Voted for: ${election.positions.map(p => `${p.name}: ${p.candidate}`).join(', ')}</p>
                        <div class="vote-date">Voted on: ${formatDate(election.date)}</div>
                    </div>
                    <div>
                        <span class="badge badge-completed">Completed</span>
                        <button class="btn-view" onclick="viewElectionResults(${election.id})">View Results</button>
                    </div>
                </div>
            `).join('');

            document.getElementById('historyList').innerHTML = historyHtml;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function viewElectionResults(electionId) {
            window.location.href = `election-results.html?id=${electionId}`;
        }

        // Logout
        document.getElementById('logout').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.clear();
            window.location.href = '/';
        });

        // Initialize
        checkAuth();
    </script>
</body>
</html>
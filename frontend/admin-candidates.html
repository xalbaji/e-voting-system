<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Candidates - E-Voting System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #34495e;
        }

        .sidebar-header h2 {
            color: #ecf0f1;
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            color: #bdc3c7;
            font-size: 14px;
        }

        .sidebar-nav ul {
            list-style: none;
            padding: 20px 0;
        }

        .sidebar-nav li {
            margin-bottom: 5px;
        }

        .sidebar-nav a {
            display: block;
            padding: 12px 25px;
            color: #ecf0f1;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            background: #34495e;
            border-left-color: #3498db;
        }

        .sidebar-nav i {
            margin-right: 10px;
            width: 20px;
            display: inline-block;
            font-style: normal;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 30px;
        }

        .header {
            background: white;
            padding: 25px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2c3e50;
        }

        .btn-create {
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn-create:hover {
            background: #219a52;
        }

        /* Stats Card */
        .stats-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .stats-icon {
            font-size: 48px;
            background: #3498db20;
            color: #3498db;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stats-info h2 {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .stats-number {
            font-size: 48px;
            font-weight: bold;
            color: #2c3e50;
        }

        .stats-label {
            color: #95a5a6;
            font-size: 14px;
        }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* Candidate Form */
        .candidate-form {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .candidate-form h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .election-selector {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }

        .election-selector label {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 10px;
            display: block;
        }

        .photo-upload {
            border: 2px dashed #ddd;
            padding: 20px;
            text-align: center;
            border-radius: 5px;
            background: #f8f9fa;
        }

        .photo-upload input {
            display: none;
        }

        .photo-label {
            display: inline-block;
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .photo-label:hover {
            background: #2980b9;
        }

        .photo-preview {
            max-width: 100px;
            max-height: 100px;
            margin: 10px auto;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid #3498db;
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-hint {
            color: #95a5a6;
            font-size: 12px;
            margin-top: 10px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-save {
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-save:hover {
            background: #219a52;
        }

        .btn-close {
            padding: 10px 20px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-close:hover {
            background: #7f8c8d;
        }

        /* Candidates List */
        .candidates-list {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .candidates-list h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .election-filter {
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .election-filter select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .election-group {
            margin-bottom: 30px;
        }

        .election-group h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #dee2e6;
            font-size: 16px;
        }

        .candidate-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .candidate-item:last-child {
            border-bottom: none;
        }

        .candidate-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .candidate-avatar {
            width: 50px;
            height: 50px;
            background: #3498db20;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #3498db;
            font-size: 20px;
            font-weight: bold;
        }

        .candidate-details h3 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .candidate-details p {
            color: #7f8c8d;
            font-size: 14px;
        }

        .candidate-election {
            font-size: 12px;
            color: #3498db;
            background: #e3f2fd;
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
            margin-top: 5px;
        }

        .candidate-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            background: #d4edda;
            color: #155724;
            margin-left: 10px;
        }

        .candidate-actions {
            display: flex;
            gap: 10px;
        }

        .btn-edit {
            padding: 5px 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-edit:hover {
            background: #2980b9;
        }

        .btn-delete {
            padding: 5px 15px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #2c3e50;
            color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 2000;
            display: none;
            max-width: 400px;
        }

        .notification.success {
            background: #27ae60;
        }

        .notification.error {
            background: #e74c3c;
        }

        .notification.info {
            background: #3498db;
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-left: 10px;
            border: 2px solid #95a5a6;
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <div class="container">
        <!-- Sidebar with Icons -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>E-VOTING</h2>
                <p>Admin Panel</p>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="admin-dashboard.html"><i>üìä</i> Dashboard</a></li>
                    <li><a href="admin-elections.html"><i>üó≥Ô∏è</i> Elections</a></li>
                    <li><a href="admin-positions.html"><i>üìå</i> Positions</a></li>
                    <li><a href="admin-candidates.html" class="active"><i>üë§</i> Candidates</a></li>
                    <li><a href="admin-voters.html"><i>üë•</i> Voters</a></li>
                    <li><a href="admin-staff.html"><i>üë•</i> Staff</a></li>
                    <li><a href="admin-reports.html"><i>üìà</i> Reports</a></li>
                    <li><a href="admin-audit-logs.html"><i>üìã</i> Audit Logs</a></li>
                    <li><a href="#" id="logout"><i>üö™</i> Logout</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <h1>Manage Candidates</h1>
                <button class="btn-create" onclick="showCreateForm()">+ Create New Candidate</button>
            </div>

            <!-- Stats Card -->
            <div class="stats-card">
                <div class="stats-icon">üë§</div>
                <div class="stats-info">
                    <h2>Total Candidates</h2>
                    <div class="stats-number" id="totalCandidates">0</div>
                    <div class="stats-label">Active candidates across all elections</div>
                </div>
            </div>

            <div class="content-grid">
                <!-- Create/Edit Form -->
                <div class="candidate-form" id="candidateForm" style="display: none;">
                    <h2 id="formTitle">Create New Candidate</h2>
                    
                    <!-- Election Selection -->
                    <div class="election-selector">
                        <label>Select Election</label>
                        <select id="electionSelect" required onchange="loadPositionsForElection()">
                            <option value="">Choose an election...</option>
                        </select>
                        <small style="color: #7f8c8d; display: block; margin-top: 5px;">Select which election this candidate will participate in</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" id="firstName" placeholder="First Name" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" id="lastName" placeholder="Last Name" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Position</label>
                        <select id="positionSelect" required disabled>
                            <option value="">Select Election First</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Biography</label>
                        <textarea id="biography" placeholder="Enter candidate biography"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Photo</label>
                        <div class="photo-upload">
                            <input type="file" id="photo" accept="image/*" onchange="previewImage(this)">
                            <label for="photo" class="photo-label">Choose File</label>
                            <div class="photo-preview" id="photoPreview">
                                <img src="" alt="Preview" style="display: none;">
                            </div>
                            <p id="fileName">No file chosen</p>
                            <div class="photo-hint">Leave empty to keep existing photo when updating</div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="btn-close" onclick="hideForm()">Close</button>
                        <button class="btn-save" id="saveBtn" onclick="createCandidate()">Save Candidate</button>
                    </div>
                </div>

                <!-- Candidates List -->
                <div class="candidates-list">
                    <h2>Current Candidates</h2>
                    
                    <!-- Filter by Election -->
                    <div class="election-filter">
                        <select id="filterElection" onchange="filterCandidatesByElection()">
                            <option value="all">All Elections</option>
                        </select>
                    </div>
                    
                    <div id="candidatesList">
                        <div class="loading">Loading candidates...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
  // At the top of each HTML file's script section
const API_BASE_URL = '/api';


        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Check authentication
        async function checkAuth() {
            const token = localStorage.getItem('token');
            const userStr = localStorage.getItem('user');
            
            if (!token || !userStr) {
                window.location.href = '/';
                return;
            }

            try {
                const user = JSON.parse(userStr);
                if (user.role !== 'admin') {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Auth error:', error);
                window.location.href = '/';
            }
        }

        // Load elections for dropdown
        async function loadElections() {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_BASE_URL}/admin/elections`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    elections = await response.json();
                    
                    // Populate election select in form
                    const electionSelect = document.getElementById('electionSelect');
                    electionSelect.innerHTML = '<option value="">Choose an election...</option>';
                    
                    // Populate filter dropdown
                    const filterSelect = document.getElementById('filterElection');
                    filterSelect.innerHTML = '<option value="all">All Elections</option>';
                    
                    elections.forEach(election => {
                        electionSelect.innerHTML += `<option value="${election.id}">${election.title}</option>`;
                        filterSelect.innerHTML += `<option value="${election.id}">${election.title}</option>`;
                    });
                } else {
                    showNotification('Failed to load elections', 'error');
                }
            } catch (error) {
                console.error('Error loading elections:', error);
                showNotification('Error connecting to server', 'error');
            }
        }

        // Load positions for selected election
        async function loadPositionsForElection() {
            const electionId = document.getElementById('electionSelect').value;
            const positionSelect = document.getElementById('positionSelect');
            
            if (!electionId) {
                positionSelect.innerHTML = '<option value="">Select Election First</option>';
                positionSelect.disabled = true;
                return;
            }

            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/positions?election_id=${electionId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    positions = await response.json();
                    
                    positionSelect.innerHTML = '<option value="">Select Position</option>';
                    positions.forEach(position => {
                        positionSelect.innerHTML += `<option value="${position.id}">${position.position_name}</option>`;
                    });
                    positionSelect.disabled = false;
                } else {
                    showNotification('Failed to load positions', 'error');
                }
            } catch (error) {
                console.error('Error loading positions:', error);
                showNotification('Error connecting to server', 'error');
            }
        }

        // Load candidates
        async function loadCandidates() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/candidates`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    allCandidates = await response.json();
                    
                    // Fetch election details for each candidate if not included
                    for (let candidate of allCandidates) {
                        if (!candidate.election && candidate.position?.election_id) {
                            const electionResponse = await fetch(`${API_BASE_URL}/admin/elections/${candidate.position.election_id}`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            if (electionResponse.ok) {
                                candidate.election = await electionResponse.json();
                            }
                        }
                    }
                    
                    displayCandidates(allCandidates);
                    document.getElementById('totalCandidates').textContent = allCandidates.length;
                } else {
                    showNotification('Failed to load candidates', 'error');
                }
            } catch (error) {
                console.error('Error loading candidates:', error);
                showNotification('Error connecting to server', 'error');
            }
        }

        // Display candidates grouped by election
        function displayCandidates(candidates) {
            const container = document.getElementById('candidatesList');
            
            if (candidates.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px;">No candidates found</p>';
                return;
            }

            // Group by election title
            const groupedByElection = {};
            candidates.forEach(candidate => {
                const electionTitle = candidate.election?.title || 
                                     candidate.position?.election?.title || 
                                     'Unassigned';
                if (!groupedByElection[electionTitle]) {
                    groupedByElection[electionTitle] = [];
                }
                groupedByElection[electionTitle].push(candidate);
            });

            let html = '';
            for (const [electionTitle, electionCandidates] of Object.entries(groupedByElection)) {
                html += `<div class="election-group">`;
                html += `<h3>${electionTitle}</h3>`;
                
                electionCandidates.forEach(candidate => {
                    const initials = (candidate.first_name?.[0] || '') + (candidate.last_name?.[0] || '');
                    const positionName = candidate.position?.position_name || 'No position';
                    
                    html += `
                        <div class="candidate-item">
                            <div class="candidate-info">
                                <div class="candidate-avatar">${initials || '?'}</div>
                                <div class="candidate-details">
                                    <h3>${candidate.first_name} ${candidate.last_name}</h3>
                                    <p>${positionName}</p>
                                </div>
                            </div>
                            <div class="candidate-actions">
                                <button class="btn-edit" onclick="editCandidate(${candidate.id})">Edit</button>
                                <button class="btn-delete" onclick="deleteCandidate(${candidate.id})">Delete</button>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            container.innerHTML = html;
        }

        // Filter candidates by election
        function filterCandidatesByElection() {
            const electionId = document.getElementById('filterElection').value;
            
            if (electionId === 'all') {
                displayCandidates(allCandidates);
            } else {
                const filtered = allCandidates.filter(c => {
                    const candidateElectionId = c.election?.id || c.position?.election_id;
                    return candidateElectionId == electionId;
                });
                displayCandidates(filtered);
            }
        }

        // Preview image
        function previewImage(input) {
            const fileName = document.getElementById('fileName');
            const preview = document.getElementById('photoPreview').querySelector('img');
            
            if (input.files && input.files[0]) {
                fileName.textContent = input.files[0].name;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Show create form
        function showCreateForm() {
            document.getElementById('formTitle').textContent = 'Create New Candidate';
            document.getElementById('firstName').value = '';
            document.getElementById('lastName').value = '';
            document.getElementById('biography').value = '';
            document.getElementById('electionSelect').value = '';
            document.getElementById('positionSelect').innerHTML = '<option value="">Select Election First</option>';
            document.getElementById('positionSelect').disabled = true;
            document.getElementById('fileName').textContent = 'No file chosen';
            document.getElementById('photoPreview').querySelector('img').style.display = 'none';
            
            currentCandidateId = null;
            document.getElementById('candidateForm').style.display = 'block';
        }

        // Hide form
        function hideForm() {
            document.getElementById('candidateForm').style.display = 'none';
            currentCandidateId = null;
        }

        // Create candidate
        async function createCandidate() {
            const token = localStorage.getItem('token');
            const candidateData = {
                first_name: document.getElementById('firstName').value,
                last_name: document.getElementById('lastName').value,
                position_id: parseInt(document.getElementById('positionSelect').value),
                biography: document.getElementById('biography').value,
                status: 'active'
            };

            if (!candidateData.first_name || !candidateData.last_name || !candidateData.position_id) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/admin/candidates`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(candidateData)
                });

                if (response.ok) {
                    showNotification('Candidate created successfully', 'success');
                    hideForm();
                    loadCandidates();
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to create candidate', 'error');
                }
            } catch (error) {
                console.error('Error creating candidate:', error);
                showNotification('Error connecting to server', 'error');
            }
        }

        // Edit candidate
        async function editCandidate(id) {
            // Find the candidate
            const candidate = allCandidates.find(c => c.id === id);
            if (!candidate) {
                showNotification('Candidate not found', 'error');
                return;
            }

            // Set form title
            document.getElementById('formTitle').textContent = 'Edit Candidate';
            
            // Set basic info
            document.getElementById('firstName').value = candidate.first_name || '';
            document.getElementById('lastName').value = candidate.last_name || '';
            document.getElementById('biography').value = candidate.biography || '';
            
            // Set election and position
            const electionId = candidate.election?.id || candidate.position?.election_id;
            if (electionId) {
                document.getElementById('electionSelect').value = electionId;
                await loadPositionsForElection();
                
                // Small delay to ensure positions are loaded
                setTimeout(() => {
                    document.getElementById('positionSelect').value = candidate.position_id || '';
                }, 500);
            }
            
            currentCandidateId = id;
            document.getElementById('saveBtn').textContent = 'Update Candidate';
            document.getElementById('candidateForm').style.display = 'block';
        }

        // Delete candidate
        async function deleteCandidate(id) {
            if (!confirm('Are you sure you want to delete this candidate?')) return;
            
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/candidates/${id}`, {
                    method: 'DELETE',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showNotification('Candidate deleted successfully', 'success');
                    loadCandidates();
                    
                    // If the deleted candidate was being edited, hide the form
                    if (currentCandidateId === id) {
                        hideForm();
                    }
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to delete candidate', 'error');
                }
            } catch (error) {
                console.error('Error deleting candidate:', error);
                showNotification('Error connecting to server', 'error');
            }
        }

        // Simple Logout
document.getElementById('logout').addEventListener('click', (e) => {
    e.preventDefault();          // Prevent default button behavior
    localStorage.removeItem('token'); // Remove the token
    window.location.href = '/';       // Redirect to homepage
});


        // Initialize
        checkAuth();
        loadElections();
        loadCandidates();
    </script>
</body>
</html>